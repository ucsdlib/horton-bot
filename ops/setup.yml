---
- name: Configure system for Bot application
  hosts: lib-slackbots

  vars_files:
    - vars/ansistrano.yml
    - vars/bot.yml
    - vars/rbenv.yml
    - vars/slack_token.yml

  roles:
    - { role: geerlingguy.repo-epel, become: true }
    - { role: ucsdlib.ansible-role-phantomjs, become: true }
    - { role: zzet.rbenv, become: true }

  tasks:
    - name: Install dependencies
      become: yes
      package:
        name: gcc-c++
        state: present

    - name: Install bundler gem
      gem:
        name: bundler
        state: present

    - name: Install Puma service files
      become: yes
      template:
        src: "{{ item }}.j2"
        dest: /etc/systemd/system/{{ item }}
        mode: 0755
      with_items:
        - puma.service
        - puma.socket

    - name: Enable Puma service
      become: yes
      systemd:
        enabled: yes
        state: stopped
        daemon_reload: yes
        name: "{{ item }}"
      with_items:
        - puma.socket
        - puma.service

- import_playbook: deploy.yml
